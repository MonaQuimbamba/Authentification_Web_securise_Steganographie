#Clé AC (Ajouter le passphrase)
openssl ecparam -out ac_private_key.pem -name prime256v1 -genkey


#AC
openssl req -config <(printf "[req]\ndistinguished_name=dn\n[dn]\n[ext]\nbasicConstraints=CA:TRUE") -new -nodes -subj "/C=FR/L=Limoges/O=CRYPTIS/OU=CertifPlus/CN=AC_CertifPlus" -x509 -extensions ext -sha256 -key ac_private_key.pem -text -out ac.cert.pem

#clé serveur
openssl ecparam -out serv_priv.key.pem -name prime256v1 -genkey

#creation de la demande de signature

openssl req -config <(printf "[req]\ndistinguished_name=dn\n[dn]\n[ext]\nbasicConstraints=CA:FALSE") -new -subj "/C=FR/L=Limoges/O=CRYPTIS/OU=CertifPlus/CN=serveur" -reqexts ext -sha256 -key serv_priv.key.pem -text -out serv.csr.pem

#Signature
openssl x509 -req -days 365 -CA ac.cert.pem -CAkey ac_private_key.pem -CAcreateserial -extfile <(printf "basicConstraints=critical,CA:FALSE") -in serv.csr.pem -text  -out serveur_sign.pem

#signature Bloc_Info
openssl dgst -sha256 -sign  ac_private_key.pem  bloc_Info.txt > bloc_Info_sign.sig 

#Convertion ASCII
openssl base64  -in bloc_Info_sign.sig -out bloc_Info_sign_ascii.sig

#Creation du tsq(TimeStampRequest) avec openssl timestamp: requête à envoyer sur le site https://freetsa.org/tsr
openssl ts -query -data bloc_Info.txt -no_nonce -sha512 -cert -out bloc_Info.tsq
#Curl pour la demande du timestamp sur le site https://freetsa.org/tsr
curl -H "Content-Type: application/timestamp-query" --data-binary '@bloc_Info.tsq' https://freetsa.org/tsr > bloc_Info.tsr 



#Verification
openssl ts -verify -in bloc_Info.tsr -queryfile bloc_Info.tsq -CAfile cacert.pem -untrusted tsa.crt
